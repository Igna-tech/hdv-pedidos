<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes - HDV</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f3f4f6; }
        .header { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card h2 { font-size: 18px; margin-bottom: 15px; color: #111827; }
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; }
        .tab { padding: 12px 24px; background: none; border: none; font-size: 14px; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { color: #2563eb; border-bottom-color: #2563eb; }
        .filtros { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .filtro-group label { display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 5px; }
        .filtro-group select, .filtro-group input { width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; }
        .tabla { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .tabla th { background: #f3f4f6; padding: 12px; text-align: left; font-size: 14px; font-weight: 600; color: #374151; }
        .tabla td { padding: 12px; border-bottom: 1px solid #e5e7eb; font-size: 14px; }
        .tabla tr:hover { background: #f9fafb; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat-card { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); padding: 20px; border-radius: 12px; }
        .stat-label { font-size: 14px; color: #1e40af; margin-bottom: 5px; }
        .stat-value { font-size: 28px; font-weight: 700; color: #1e3a8a; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #2563eb; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“Š Reportes y AnÃ¡lisis</h1>
        <div class="subtitle">HDV Distribuciones</div>
    </div>

    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="cambiarTab('zona')">Por Zona</button>
            <button class="tab" onclick="cambiarTab('vendedor')">Por Vendedor</button>
            <button class="tab" onclick="cambiarTab('producto')">Por Producto</button>
            <button class="tab" onclick="cambiarTab('cliente')">Por Cliente</button>
        </div>

        <!-- Filtros -->
        <div class="card">
            <div class="filtros">
                <div class="filtro-group">
                    <label>Fecha Desde:</label>
                    <input type="date" id="fechaDesde">
                </div>
                <div class="filtro-group">
                    <label>Fecha Hasta:</label>
                    <input type="date" id="fechaHasta">
                </div>
                <div class="filtro-group" style="display: flex; align-items: end;">
                    <button class="btn btn-primary" onclick="generarReporte()" style="width: 100%;">Generar Reporte</button>
                </div>
            </div>
        </div>

        <!-- EstadÃ­sticas Generales -->
        <div class="card" id="statsCard" style="display: none;">
            <h2>Resumen General</h2>
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Ventas</div>
                    <div class="stat-value" id="totalVentas">Gs. 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Pedidos</div>
                    <div class="stat-value" id="totalPedidos">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ticket Promedio</div>
                    <div class="stat-value" id="ticketPromedio">Gs. 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Productos Vendidos</div>
                    <div class="stat-value" id="productosVendidos">0</div>
                </div>
            </div>
        </div>

        <!-- Tabla de Resultados -->
        <div class="card" id="resultadosCard" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 id="tituloReporte">Reporte</h2>
                <button class="btn btn-primary" onclick="exportarReporte()">ðŸ“¥ Exportar Excel</button>
            </div>
            <table class="tabla" id="tablaResultados">
                <thead id="tablaHeader"></thead>
                <tbody id="tablaBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let pedidos = [];
        let productos = [];
        let clientes = [];
        let tabActual = 'zona';

        document.addEventListener('DOMContentLoaded', async () => {
            await cargarDatos();
            
            // Establecer fechas por defecto (Ãºltimos 30 dÃ­as)
            const hoy = new Date();
            const hace30 = new Date(hoy.getTime() - 30 * 24 * 60 * 60 * 1000);
            document.getElementById('fechaHasta').valueAsDate = hoy;
            document.getElementById('fechaDesde').valueAsDate = hace30;
        });

        async function cargarDatos() {
            try {
                const response = await fetch('productos.json');
                const data = await response.json();
                productos = data.productos;
                clientes = data.clientes;
            } catch (error) {
                console.error('Error cargando datos:', error);
            }
            
            pedidos = JSON.parse(localStorage.getItem('hdv_pedidos') || '[]');
        }

        function cambiarTab(tab) {
            tabActual = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }

        function filtrarPedidos() {
            const desde = new Date(document.getElementById('fechaDesde').value);
            const hasta = new Date(document.getElementById('fechaHasta').value);
            hasta.setHours(23, 59, 59, 999);

            return pedidos.filter(p => {
                const fecha = new Date(p.fecha);
                return fecha >= desde && fecha <= hasta;
            });
        }

        function generarReporte() {
            const pedidosFiltrados = filtrarPedidos();
            
            if (pedidosFiltrados.length === 0) {
                alert('No hay pedidos en el rango de fechas seleccionado');
                return;
            }

            mostrarEstadisticas(pedidosFiltrados);
            
            switch(tabActual) {
                case 'zona':
                    reportePorZona(pedidosFiltrados);
                    break;
                case 'vendedor':
                    reportePorVendedor(pedidosFiltrados);
                    break;
                case 'producto':
                    reportePorProducto(pedidosFiltrados);
                    break;
                case 'cliente':
                    reportePorCliente(pedidosFiltrados);
                    break;
            }

            document.getElementById('statsCard').style.display = 'block';
            document.getElementById('resultadosCard').style.display = 'block';
        }

        function mostrarEstadisticas(pedidos) {
            const totalVentas = pedidos.reduce((sum, p) => sum + p.total, 0);
            const totalPedidos = pedidos.length;
            const ticketPromedio = totalVentas / totalPedidos;
            const productosVendidos = pedidos.reduce((sum, p) => 
                sum + p.items.reduce((s, i) => s + i.cantidad, 0), 0
            );

            document.getElementById('totalVentas').textContent = `Gs. ${totalVentas.toLocaleString()}`;
            document.getElementById('totalPedidos').textContent = totalPedidos;
            document.getElementById('ticketPromedio').textContent = `Gs. ${Math.round(ticketPromedio).toLocaleString()}`;
            document.getElementById('productosVendidos').textContent = productosVendidos;
        }

        function reportePorZona(pedidos) {
            const zonas = {};
            
            pedidos.forEach(p => {
                const cliente = clientes.find(c => c.id === p.cliente.id);
                const zona = cliente?.zona || 'Sin zona';
                
                if (!zonas[zona]) {
                    zonas[zona] = { pedidos: 0, total: 0, productos: 0 };
                }
                
                zonas[zona].pedidos++;
                zonas[zona].total += p.total;
                zonas[zona].productos += p.items.reduce((s, i) => s + i.cantidad, 0);
            });

            const data = Object.entries(zonas).map(([zona, datos]) => ({
                zona,
                ...datos,
                promedio: Math.round(datos.total / datos.pedidos)
            })).sort((a, b) => b.total - a.total);

            mostrarTabla(
                ['Zona', 'Pedidos', 'Total Ventas', 'Productos', 'Ticket Promedio'],
                data.map(d => [
                    d.zona,
                    d.pedidos,
                    `Gs. ${d.total.toLocaleString()}`,
                    d.productos,
                    `Gs. ${d.promedio.toLocaleString()}`
                ]),
                'Ventas por Zona'
            );
        }

        function reportePorVendedor(pedidos) {
            const vendedores = {};
            
            pedidos.forEach(p => {
                const vendedor = p.vendedor || 'Sin especificar';
                
                if (!vendedores[vendedor]) {
                    vendedores[vendedor] = { pedidos: 0, total: 0, productos: 0 };
                }
                
                vendedores[vendedor].pedidos++;
                vendedores[vendedor].total += p.total;
                vendedores[vendedor].productos += p.items.reduce((s, i) => s + i.cantidad, 0);
            });

            const data = Object.entries(vendedores).map(([vendedor, datos]) => ({
                vendedor,
                ...datos,
                promedio: Math.round(datos.total / datos.pedidos)
            })).sort((a, b) => b.total - a.total);

            mostrarTabla(
                ['Vendedor', 'Pedidos', 'Total Ventas', 'Productos', 'Ticket Promedio'],
                data.map(d => [
                    d.vendedor,
                    d.pedidos,
                    `Gs. ${d.total.toLocaleString()}`,
                    d.productos,
                    `Gs. ${d.promedio.toLocaleString()}`
                ]),
                'Ventas por Vendedor'
            );
        }

        function reportePorProducto(pedidos) {
            const prods = {};
            
            pedidos.forEach(p => {
                p.items.forEach(item => {
                    const key = `${item.nombre} (${item.presentacion})`;
                    
                    if (!prods[key]) {
                        prods[key] = { cantidad: 0, total: 0 };
                    }
                    
                    prods[key].cantidad += item.cantidad;
                    prods[key].total += item.subtotal;
                });
            });

            const data = Object.entries(prods).map(([producto, datos]) => ({
                producto,
                ...datos
            })).sort((a, b) => b.total - a.total);

            mostrarTabla(
                ['Producto', 'Unidades Vendidas', 'Total Ventas'],
                data.map(d => [
                    d.producto,
                    d.cantidad,
                    `Gs. ${d.total.toLocaleString()}`
                ]),
                'Ventas por Producto'
            );
        }

        function reportePorCliente(pedidos) {
            const clts = {};
            
            pedidos.forEach(p => {
                const cliente = p.cliente.nombre;
                const clienteInfo = clientes.find(c => c.id === p.cliente.id);
                const zona = clienteInfo?.zona || '';
                
                if (!clts[cliente]) {
                    clts[cliente] = { pedidos: 0, total: 0, productos: 0, zona };
                }
                
                clts[cliente].pedidos++;
                clts[cliente].total += p.total;
                clts[cliente].productos += p.items.reduce((s, i) => s + i.cantidad, 0);
            });

            const data = Object.entries(clts).map(([cliente, datos]) => ({
                cliente,
                ...datos,
                promedio: Math.round(datos.total / datos.pedidos)
            })).sort((a, b) => b.total - a.total);

            mostrarTabla(
                ['Cliente', 'Zona', 'Pedidos', 'Total Ventas', 'Ticket Promedio'],
                data.map(d => [
                    d.cliente,
                    d.zona,
                    d.pedidos,
                    `Gs. ${d.total.toLocaleString()}`,
                    `Gs. ${d.promedio.toLocaleString()}`
                ]),
                'Ventas por Cliente'
            );
        }

        function mostrarTabla(headers, rows, titulo) {
            document.getElementById('tituloReporte').textContent = titulo;
            
            const thead = document.getElementById('tablaHeader');
            thead.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
            
            const tbody = document.getElementById('tablaBody');
            tbody.innerHTML = rows.map(row => 
                '<tr>' + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>'
            ).join('');
        }

        function exportarReporte() {
            const tabla = document.getElementById('tablaResultados');
            let csv = '';
            
            // Headers
            const headers = Array.from(tabla.querySelectorAll('thead th')).map(th => th.textContent);
            csv += headers.join(',') + '\n';
            
            // Rows
            const rows = Array.from(tabla.querySelectorAll('tbody tr'));
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td')).map(td => `"${td.textContent}"`);
                csv += cells.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `reporte_${tabActual}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
    </script>
</body>
</html>
