<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurar Precios - HDV</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f3f4f6; }
        .header { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card h2 { font-size: 18px; margin-bottom: 15px; color: #111827; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 5px; }
        .form-group select, .form-group input { width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .precio-item { display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; align-items: center; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; }
        .success { background: #d1fae5; color: #065f46; padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center; display: none; }
        .tabla-precios { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .tabla-precios th { background: #f3f4f6; padding: 12px; text-align: left; font-size: 14px; font-weight: 600; color: #374151; }
        .tabla-precios td { padding: 12px; border-bottom: 1px solid #e5e7eb; font-size: 14px; }
        .tabla-precios input { width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚öôÔ∏è Configurar Precios Personalizados</h1>
        <div class="subtitle">HDV Distribuciones</div>
    </div>

    <div class="container">
        <div class="success" id="successMsg">‚úì Precios guardados correctamente</div>
        
        <div class="card">
            <h2>Seleccionar Cliente</h2>
            <div class="form-group">
                <label>Cliente:</label>
                <select id="clienteSelect" onchange="cargarPreciosCliente()">
                    <option value="">-- Seleccione un cliente --</option>
                </select>
            </div>
        </div>

        <div class="card" id="preciosCard" style="display: none;">
            <h2>Precios Personalizados</h2>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 15px;">
                Deja en blanco para usar el precio base. Solo configura los productos que tengan precio especial.
            </p>
            
            <div style="margin-bottom: 15px;">
                <input type="text" id="buscarProducto" placeholder="üîç Buscar producto..." style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
            </div>

            <table class="tabla-precios" id="tablaPreci√≥s">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Presentaci√≥n</th>
                        <th>Precio Base</th>
                        <th>Precio Personalizado</th>
                    </tr>
                </thead>
                <tbody id="productosBody">
                    <!-- Se llenar√° din√°micamente -->
                </tbody>
            </table>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="guardarPrecios()">üíæ Guardar Precios</button>
                <button class="btn btn-secondary" onclick="location.href='index.html'">‚Üê Volver</button>
            </div>
        </div>
    </div>

    <script>
        let productos = [];
        let clientes = [];
        let clienteActual = null;
        let preciosPersonalizados = {};

        document.addEventListener('DOMContentLoaded', async () => {
            await cargarDatos();
        });

        async function cargarDatos() {
            try {
                const response = await fetch('productos.json');
                const data = await response.json();
                productos = data.productos;
                clientes = data.clientes;
                
                const select = document.getElementById('clienteSelect');
                clientes.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = `${c.nombre} ‚Äî ${c.zona}`;
                    select.appendChild(option);
                });
            } catch (error) {
                alert('Error al cargar datos');
            }
        }

        function cargarPreciosCliente() {
            const clienteId = document.getElementById('clienteSelect').value;
            if (!clienteId) {
                document.getElementById('preciosCard').style.display = 'none';
                return;
            }

            clienteActual = clientes.find(c => c.id === clienteId);
            preciosPersonalizados = clienteActual.precios_personalizados || {};
            
            mostrarProductos();
            document.getElementById('preciosCard').style.display = 'block';
        }

        function mostrarProductos(filtro = '') {
            const tbody = document.getElementById('productosBody');
            tbody.innerHTML = '';

            let productosFiltrados = productos;
            if (filtro) {
                productosFiltrados = productos.filter(p => 
                    p.nombre.toLowerCase().includes(filtro.toLowerCase())
                );
            }

            productosFiltrados.forEach(producto => {
                producto.presentaciones.forEach((pres, idx) => {
                    const precioPersonalizado = preciosPersonalizados[producto.id]?.find(
                        p => p.tamano === pres.tamano
                    )?.precio || '';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${producto.nombre}</strong></td>
                        <td>${pres.tamano}</td>
                        <td>Gs. ${pres.precio_base.toLocaleString()}</td>
                        <td>
                            <input 
                                type="number" 
                                id="precio_${producto.id}_${idx}"
                                placeholder="Dejar vac√≠o = precio base"
                                value="${precioPersonalizado}"
                                data-producto="${producto.id}"
                                data-tamano="${pres.tamano}"
                            >
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });

            // Buscador
            document.getElementById('buscarProducto').oninput = (e) => {
                mostrarProductos(e.target.value);
            };
        }

        async function guardarPrecios() {
            if (!clienteActual) return;

            const inputs = document.querySelectorAll('[data-producto]');
            const nuevosPrecios = {};

            inputs.forEach(input => {
                const productoId = input.dataset.producto;
                const tamano = input.dataset.tamano;
                const precio = parseInt(input.value) || 0;

                if (precio > 0) {
                    if (!nuevosPrecios[productoId]) {
                        nuevosPrecios[productoId] = [];
                    }
                    nuevosPrecios[productoId].push({ tamano, precio });
                }
            });

            // Actualizar en productos.json
            const response = await fetch('productos.json');
            const data = await response.json();
            
            const cliente = data.clientes.find(c => c.id === clienteActual.id);
            cliente.precios_personalizados = nuevosPrecios;

            // Guardar (en localStorage por ahora, luego lo descargas y subes a GitHub)
            localStorage.setItem('productos_data', JSON.stringify(data));

            // Mostrar mensaje
            const msg = document.getElementById('successMsg');
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);

            // Descargar archivo actualizado
            descargarJSON(data);
        }

        function descargarJSON(data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'productos.json';
            a.click();
            
            alert('‚úì Precios guardados! Descarga el archivo productos.json y s√∫belo a GitHub para actualizar.');
        }
    </script>
</body>
</html>
